# ============================================================================
# SQL审计服务配置 - Elasticsearch单数据库模式
# ============================================================================
#
# 适用场景:
#   - 需要强大的全文搜索能力
#   - 已有Elasticsearch基础设施
#   - 需要Kibana可视化分析
#   - 数据量中等（日均SQL审计量 100万-1000万）
#
# 架构说明:
#   - Elasticsearch: 存储所有数据（元数据 + 时序日志）
#   - 优点:
#     - 全文搜索能力强
#     - Kibana可视化强大
#     - 横向扩展容易
#   - 缺点:
#     - 事务支持弱
#     - 复杂关系查询性能差
#
# ============================================================================

spring:
  application:
    name: sql-audit-service

  # 虚拟线程配置 (JDK 21+)
  threads:
    virtual:
      enabled: true

  # Kafka配置
  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      bootstrap-servers: localhost:9092
      group-id: sql-audit-service
      auto-offset-reset: earliest
      enable-auto-commit: false
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      properties:
        session.timeout.ms: 30000
        heartbeat.interval.ms: 10000
        max.poll.records: 1000
        max.poll.interval.ms: 300000
    producer:
      bootstrap-servers: localhost:9092
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer
      acks: all
      retries: 3

# ============================================================================
# SQL审计服务核心配置
# ============================================================================
audit:
  # Kafka消费者配置
  kafka:
    topic: sql-audit-events
    consumer:
      group-id: audit-service
      dlq-topic: sql-audit-events-dlq

      # 错误处理器配置
      error-handler:
        retry-initial-interval: 1000
        retry-multiplier: 2.0
        max-attempts: 3

      # 背压控制配置
      backpressure:
        enabled: true
        latency-threshold-ms: 300  # ES批量写入可能较慢
        failure-threshold: 5
        check-interval-ms: 5000

      # 虚拟线程配置
      virtual-thread:
        enabled: true
        name-prefix: kafka-virtual-
        concurrency: 4

  # 审计引擎配置
  engine:
    checker-timeout-ms: 200
    whitelist-rules: []

  # 存储配置 - Elasticsearch单数据库模式
  storage:
    # 存储模式: 仅使用Elasticsearch
    mode: elasticsearch

    # Elasticsearch配置
    elasticsearch:
      # ES集群地址，多个地址用逗号分隔（推荐至少3个节点）
      hosts: es-node-1:9200,es-node-2:9200,es-node-3:9200

      # 认证配置
      username: elastic
      password: your_es_password_here

      # SSL配置（生产环境建议启用）
      ssl-enabled: true

      # 连接超时配置
      connect-timeout: 5000
      socket-timeout: 60000

    # 数据保留配置
    retention:
      enabled: true
      retention-days: 90
      cron: "0 0 2 * * *"  # 每天凌晨2点执行清理

# ============================================================================
# 监控配置
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,prometheus,info,metrics
  endpoint:
    health:
      show-details: always
    prometheus:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# ============================================================================
# 日志配置
# ============================================================================
logging:
  level:
    root: INFO
    com.footstone.audit: DEBUG
    org.springframework.kafka: WARN
    org.elasticsearch.client: INFO
    co.elastic.clients: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ============================================================================
# 环境标识
# ============================================================================
environment:
  name: elasticsearch-mode

# ============================================================================
# Elasticsearch优化建议
# ============================================================================
# 1. 索引模板设计:
#    PUT _index_template/execution_logs_template
#    {
#      "index_patterns": ["execution_logs-*"],
#      "template": {
#        "settings": {
#          "number_of_shards": 3,
#          "number_of_replicas": 1,
#          "refresh_interval": "30s",
#          "index": {
#            "codec": "best_compression"
#          }
#        },
#        "mappings": {
#          "properties": {
#            "timestamp": { "type": "date" },
#            "sql_text": {
#              "type": "text",
#              "analyzer": "standard",
#              "fields": {
#                "keyword": { "type": "keyword", "ignore_above": 256 }
#              }
#            },
#            "sql_type": { "type": "keyword" },
#            "mapper_id": { "type": "keyword" },
#            "execution_time_ms": { "type": "integer" },
#            "risk_level": { "type": "keyword" },
#            "metadata": { "type": "object", "enabled": true }
#          }
#        }
#      }
#    }
#
# 2. 索引生命周期管理 (ILM):
#    PUT _ilm/policy/execution_logs_policy
#    {
#      "policy": {
#        "phases": {
#          "hot": {
#            "actions": {
#              "rollover": {
#                "max_size": "50GB",
#                "max_age": "7d"
#              }
#            }
#          },
#          "warm": {
#            "min_age": "7d",
#            "actions": {
#              "readonly": {},
#              "forcemerge": {
#                "max_num_segments": 1
#              },
#              "shrink": {
#                "number_of_shards": 1
#              }
#            }
#          },
#          "cold": {
#            "min_age": "30d",
#            "actions": {
#              "searchable_snapshot": {
#                "snapshot_repository": "audit_backup"
#              }
#            }
#          },
#          "delete": {
#            "min_age": "90d",
#            "actions": {
#              "delete": {}
#            }
#          }
#        }
#      }
#    }
#
# 3. 数据流（推荐方式）:
#    PUT _data_stream/execution_logs
#
# 4. 批量写入优化:
#    - 使用bulk API批量写入
#    - 批量大小建议: 5-15MB
#    - 增加refresh_interval降低实时性提高性能
#
# 5. 查询优化:
#    - 使用filter而不是query（可缓存）
#    - 避免使用通配符开头的查询
#    - 使用聚合代替脚本
#    - 合理使用routing提高查询性能
#
# 6. 集群配置:
#    - 至少3个master节点
#    - 数据节点根据数据量调整
#    - 配置专用协调节点处理查询
#    - heap大小设置为物理内存50%，不超过32GB
#
# 7. 监控指标:
#    - 集群健康状态（green/yellow/red）
#    - JVM堆使用率（< 75%）
#    - 索引速度和查询延迟
#    - 分片分布情况
#
# 8. Kibana可视化:
#    - 创建Index Pattern: execution_logs-*
#    - 配置仪表板展示SQL审计趋势
#    - 设置告警规则
#    - 使用Canvas创建报表
