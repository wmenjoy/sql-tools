# Phase 13: InnerInterceptor Architecture - ä¾èµ–å…³ç³»åˆ†æ

## æ¦‚è¿°

æœ¬æ–‡æ¡£åˆ†æ Phase 13 çš„å®Œæ•´ä¾èµ–å…³ç³»ï¼ŒåŒ…æ‹¬ï¼š
1. ä»»åŠ¡é—´ä¾èµ–å…³ç³»ï¼ˆå†…éƒ¨ä¾èµ–ï¼‰
2. è·¨ Phase ä¾èµ–å…³ç³»ï¼ˆå¤–éƒ¨ä¾èµ–ï¼‰
3. å…³é”®è·¯å¾„åˆ†æ
4. å¹¶è¡Œæ‰§è¡Œæœºä¼š
5. é£é™©è¯„ä¼°

---

## âš ï¸ é‡è¦è¯´æ˜ï¼šä»»åŠ¡ç¼–å· â‰  æ‰§è¡Œé¡ºåº

**å…³é”®ç†è§£**:
- **ä»»åŠ¡ç¼–å· (13.1, 13.2, ..., 13.6)** æ˜¯ç»„ç»‡æ€§çš„æ ‡è¯†ç¬¦ï¼ŒNOT æ‰§è¡Œé¡ºåº
- **æ‰§è¡Œé¡ºåº** ç”±ä»»åŠ¡é—´çš„å®é™…ä¾èµ–å…³ç³»å†³å®š

**ä¸ºä»€ä¹ˆ Task 13.6 ç¼–å·åœ¨åä½†éœ€è¦ä¼˜å…ˆæ‰§è¡Œï¼Ÿ**

ä» Implementation Plan çš„ Guidance å¯ä»¥çœ‹åˆ°:
```
Task 13.2 Guidance: "cache Statement in StatementContext.cache(sql, statement)"
Task 13.3 Guidance: "get Statement from StatementContext (reuse if cached)"
Task 13.4 Guidance: "get Statement from StatementContext.get(sql)"
Task 13.6 Objective: "Create StatementContext class"
```

**ç»“è®º**:
- Task 13.6 **åˆ›å»º** StatementContext ç±»
- Tasks 13.2/13.3/13.4 **ä½¿ç”¨** StatementContext ç±»
- å› æ­¤ Task 13.6 å¿…é¡»åœ¨ 13.2/13.3/13.4 **ä¹‹å‰**æ‰§è¡Œ

**æ­£ç¡®çš„æ‰§è¡Œé¡ºåº**:
```
Phase 1: 13.1 (Interface) + 13.6 (StatementContext) - å¹¶è¡Œæ‰§è¡Œ
Phase 2: 13.2, 13.3, 13.4, 13.5 - å¯å¹¶è¡Œæ‰§è¡Œï¼ˆä¾èµ– 13.1 + 13.6ï¼‰
```

---

## 1. ä»»åŠ¡æ¸…å•ä¸äº§å‡º

| ä»»åŠ¡ | ä»»åŠ¡åç§° | è´Ÿè´£ Agent | æ ¸å¿ƒäº§å‡º |
|------|---------|-----------|---------|
| **13.1** | SqlGuardInnerInterceptor æ¥å£è®¾è®¡ | Agent_Advanced_Interceptor | `SqlGuardInnerInterceptor` æ¥å£ |
| **13.2** | SqlGuardInterceptor ä¸»æ‹¦æˆªå™¨å®ç° | Agent_Advanced_Interceptor | `SqlGuardInterceptor` ç±» |
| **13.3** | SqlGuardCheckInnerInterceptor å®ç° | Agent_Advanced_Interceptor | `SqlGuardCheckInnerInterceptor` ç±» |
| **13.4** | SqlGuardRewriteInnerInterceptor å®ç° | Agent_Advanced_Interceptor | `SqlGuardRewriteInnerInterceptor` ç±» |
| **13.5** | SelectLimitInnerInterceptor å®ç° | Agent_Advanced_Interceptor | `SelectLimitInnerInterceptor` + Dialects |
| **13.6** | StatementContext ThreadLocal å…±äº« | Agent_Advanced_Interceptor | `StatementContext` ç±» |

---

## 2. ä»»åŠ¡é—´ä¾èµ–å…³ç³»å›¾

### ä¾èµ–å…³ç³»å¯è§†åŒ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Phase 13 Task Dependencies                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    [Phase 12 Complete]
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚  Task 13.1 â”‚             â”‚Task 13.6â”‚
        â”‚  Interface â”‚             â”‚ Context â”‚
        â”‚   Design   â”‚             â”‚ThreadLclâ”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚         â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    â”‚         â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            â”‚         â”‚            â”‚              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Task 13.2  â”‚ â”‚Task 13.3â”‚ â”‚Task 13.4â”‚ â”‚Task 13.5 â”‚ â”‚ (Optional) â”‚
â”‚   Main     â”‚ â”‚  Check  â”‚ â”‚ Rewrite â”‚ â”‚  Limit   â”‚ â”‚Integration â”‚
â”‚Interceptor â”‚ â”‚  Inner  â”‚ â”‚  Inner  â”‚ â”‚  Inner   â”‚ â”‚   Tests    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚            â”‚           â”‚            â”‚              â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                          â”‚  Phase 13 â”‚
                          â”‚  Complete â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
  â”€â”€â”€â–¶ : å¼ºä¾èµ–ï¼ˆå¿…é¡»ç­‰å¾…å®Œæˆï¼‰
  â•â•â•â–¶ : å¯é€‰ä¾èµ–ï¼ˆå»ºè®®ä½†ä¸å¼ºåˆ¶ï¼‰
```

---

## 3. è¯¦ç»†ä¾èµ–åˆ†æ

### Task 13.1 - SqlGuardInnerInterceptor Interface Design

**è¾“å…¥ä¾èµ–**:
- âœ… Phase 12 Complete (SqlContext æœ‰ statement å­—æ®µ)
- âœ… MyBatis API (Executor, MappedStatement, BoundSql ç­‰)

**è¾“å‡ºäº§ç‰©**:
- `SqlGuardInnerInterceptor` æ¥å£ï¼ˆ5 ä¸ªæ–¹æ³•ï¼‰
  - `boolean willDoQuery(...)`
  - `void beforeQuery(...)`
  - `boolean willDoUpdate(...)`
  - `void beforeUpdate(...)`
  - `int getPriority()`

**è¢«ä¾èµ–çš„ä»»åŠ¡**:
- Task 13.2 (éœ€è¦æ¥å£å®šä¹‰)
- Task 13.3 (éœ€è¦æ¥å£å®šä¹‰)
- Task 13.4 (éœ€è¦æ¥å£å®šä¹‰)
- Task 13.5 (éœ€è¦æ¥å£å®šä¹‰)

**å¹¶è¡Œæœºä¼š**: âœ… å¯ä¸ Task 13.6 å¹¶è¡Œæ‰§è¡Œ

**å…³é”®æ€§**: ğŸ”´ **å…³é”®è·¯å¾„ä»»åŠ¡**ï¼ˆæ‰€æœ‰å…¶ä»–ä»»åŠ¡ä¾èµ–æ­¤æ¥å£ï¼‰

---

### Task 13.2 - SqlGuardInterceptor Main Interceptor Implementation

**è¾“å…¥ä¾èµ–**:
- âœ… Task 13.1 (SqlGuardInnerInterceptor æ¥å£)
- âœ… Task 13.6 (StatementContext ç±»)
- âœ… Phase 12 (JSqlParserFacade)

**è¾“å‡ºäº§ç‰©**:
- `SqlGuardInterceptor` ç±»
  - @Intercepts æ³¨è§£é…ç½®
  - InnerInterceptor é“¾ç®¡ç†
  - ä¼˜å…ˆçº§æ’åºé€»è¾‘
  - ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è°ƒç”¨
  - ThreadLocal æ¸…ç†é€»è¾‘

**è¢«ä¾èµ–çš„ä»»åŠ¡**:
- æ— ï¼ˆé›†æˆæµ‹è¯•ä¼šç”¨åˆ°ï¼Œä½†ä¸æ˜¯å¼ºä¾èµ–ï¼‰

**å¹¶è¡Œæœºä¼š**: âœ… å¯ä¸ Task 13.3, 13.4, 13.5 å¹¶è¡Œæ‰§è¡Œ

**å…³é”®æ€§**: ğŸŸ¡ é‡è¦ä½†ä¸åœ¨å…³é”®è·¯å¾„

---

### Task 13.3 - SqlGuardCheckInnerInterceptor Implementation

**è¾“å…¥ä¾èµ–**:
- âœ… Task 13.1 (SqlGuardInnerInterceptor æ¥å£)
- âœ… Task 13.6 (StatementContext ç±»)
- âœ… Phase 12 (RuleChecker æ¥å£å’Œå®ç°)

**è¾“å‡ºäº§ç‰©**:
- `SqlGuardCheckInnerInterceptor` ç±»
  - Priority: 10
  - RuleChecker æ¡¥æ¥é€»è¾‘
  - ViolationStrategy å¤„ç†

**è¢«ä¾èµ–çš„ä»»åŠ¡**:
- æ— 

**å¹¶è¡Œæœºä¼š**: âœ… å¯ä¸ Task 13.2, 13.4, 13.5 å¹¶è¡Œæ‰§è¡Œ

**å…³é”®æ€§**: ğŸŸ¡ é‡è¦ä½†ä¸åœ¨å…³é”®è·¯å¾„

**ç‰¹æ®Šè¯´æ˜**: è¿™æ˜¯æœ€é‡è¦çš„ InnerInterceptorï¼Œæ¡¥æ¥ Phase 12 çš„ RuleChecker

---

### Task 13.4 - SqlGuardRewriteInnerInterceptor Implementation

**è¾“å…¥ä¾èµ–**:
- âœ… Task 13.1 (SqlGuardInnerInterceptor æ¥å£)
- âœ… Task 13.6 (StatementContext ç±»)
- â“ StatementRewriter æ¥å£ï¼ˆæ–‡æ¡£ä¸­æœªæ˜ç¡®å®šä¹‰ï¼Œå¯èƒ½éœ€è¦è®¾è®¡ï¼‰

**è¾“å‡ºäº§ç‰©**:
- `SqlGuardRewriteInnerInterceptor` ç±»
  - Priority: 200
  - StatementRewriter æ¡¥æ¥é€»è¾‘
  - BoundSql åå°„ä¿®æ”¹é€»è¾‘
  - é“¾å¼é‡å†™æ”¯æŒ

**è¢«ä¾èµ–çš„ä»»åŠ¡**:
- æ— 

**å¹¶è¡Œæœºä¼š**: âœ… å¯ä¸ Task 13.2, 13.3, 13.5 å¹¶è¡Œæ‰§è¡Œ

**å…³é”®æ€§**: ğŸŸ¢ å¯é€‰åŠŸèƒ½

**ç‰¹æ®Šè¯´æ˜**: StatementRewriter æ¥å£å¯èƒ½éœ€è¦å…ˆå®šä¹‰ï¼ˆå»ºè®®ä½œä¸º Task 13.4 çš„ä¸€éƒ¨åˆ†ï¼‰

---

### Task 13.5 - SelectLimitInnerInterceptor Implementation

**è¾“å…¥ä¾èµ–**:
- âœ… Task 13.1 (SqlGuardInnerInterceptor æ¥å£)
- âœ… Task 13.6 (StatementContext ç±»)
- âœ… MyBatis-Plus JsqlParserSupportï¼ˆå¦‚æœä½¿ç”¨ï¼‰

**è¾“å‡ºäº§ç‰©**:
- `SelectLimitInnerInterceptor` ç±»
  - Priority: 150
  - åˆ†é¡µæ£€æµ‹é€»è¾‘
  - è‡ªåŠ¨ LIMIT æ·»åŠ 
- `SqlGuardDialect` æ¥å£
- Dialect å®ç°ç±»:
  - `MySQLDialect`
  - `OracleDialect`
  - `SQLServerDialect`
  - `PostgreSQLDialect`
- `DialectFactory` è‡ªåŠ¨æ£€æµ‹ç±»

**è¢«ä¾èµ–çš„ä»»åŠ¡**:
- æ— 

**å¹¶è¡Œæœºä¼š**: âœ… å¯ä¸ Task 13.2, 13.3, 13.4 å¹¶è¡Œæ‰§è¡Œ

**å…³é”®æ€§**: ğŸŸ¡ é‡è¦é™çº§åŠŸèƒ½

**ç‰¹æ®Šè¯´æ˜**: æœ€å¤æ‚çš„ InnerInterceptorï¼ˆå¤šæ•°æ®åº“æ”¯æŒï¼‰

---

### Task 13.6 - StatementContext ThreadLocal Sharing

**è¾“å…¥ä¾èµ–**:
- âœ… æ— ï¼ˆçº¯å·¥å…·ç±»ï¼‰

**è¾“å‡ºäº§ç‰©**:
- `StatementContext` ç±»
  - ThreadLocal<Map<String, Statement>> cache
  - `cache(String sql, Statement statement)` æ–¹æ³•
  - `get(String sql)` æ–¹æ³•
  - `clear()` æ–¹æ³•

**è¢«ä¾èµ–çš„ä»»åŠ¡**:
- Task 13.2 (éœ€è¦ cache/get/clear)
- Task 13.3 (éœ€è¦ get/cache)
- Task 13.4 (éœ€è¦ get)
- Task 13.5 (éœ€è¦ get)

**å¹¶è¡Œæœºä¼š**: âœ… å¯ä¸ Task 13.1 å¹¶è¡Œæ‰§è¡Œ

**å…³é”®æ€§**: ğŸ”´ **å…³é”®è·¯å¾„ä»»åŠ¡**ï¼ˆå¤šä¸ªä»»åŠ¡ä¾èµ–ï¼‰

---

## 4. è·¨ Phase ä¾èµ–å…³ç³»

### Phase 12 ä¾èµ–ï¼ˆå¼ºä¾èµ–ï¼‰

| Phase 12 äº§å‡º | ç”¨äº Phase 13 ä»»åŠ¡ | ç”¨é€” |
|--------------|------------------|------|
| **SqlContext.statement** | Task 13.3 | æ„å»º SqlContext ä¼ é€’ç»™ RuleChecker |
| **RuleChecker æ¥å£** | Task 13.3 | SqlGuardCheckInnerInterceptor æ¡¥æ¥ |
| **æ‰€æœ‰ Checker å®ç°** | Task 13.3 | æ‰§è¡Œ SQL å®‰å…¨æ£€æŸ¥ |
| **JSqlParserFacade** | Task 13.2 | è§£æ SQL å¹¶ç¼“å­˜åˆ° ThreadLocal |
| **ValidationResult** | Task 13.3 | æ”¶é›†æ£€æŸ¥ç»“æœ |
| **ViolationStrategy** | Task 13.3 | å¤„ç†è¿è§„ç­–ç•¥ï¼ˆBLOCK/WARN/LOGï¼‰|

**éªŒè¯**: âœ… Phase 12 å·² 100% å®Œæˆï¼Œæ‰€æœ‰ä¾èµ–å¯ç”¨

---

### Phase 11 ä¾èµ–ï¼ˆå¼±ä¾èµ–ï¼Œå¯é€‰ï¼‰

| Phase 11 äº§å‡º | ç”¨äº Phase 13 ä»»åŠ¡ | æ˜¯å¦å¿…éœ€ |
|--------------|------------------|---------|
| æ¨¡å—ç»“æ„ | Task 13.2-13.5 | âŒ å¦ï¼ˆæ¶æ„è®¾è®¡å‚è€ƒï¼‰ |

**è¯´æ˜**: Phase 11 çš„æ¨¡å—æ‹†åˆ†ä¸æ˜¯ Phase 13 çš„å¼ºä¾èµ–ï¼ŒPhase 13 å¯ä»¥åœ¨ä¸å®Œæˆ Phase 11 çš„æƒ…å†µä¸‹å®æ–½ã€‚

---

### MyBatis/MyBatis-Plus ä¾èµ–ï¼ˆå¤–éƒ¨ï¼‰

| å¤–éƒ¨ä¾èµ– | ç‰ˆæœ¬è¦æ±‚ | ç”¨äºä»»åŠ¡ |
|---------|---------|---------|
| MyBatis | 3.4.x / 3.5.x | Task 13.1, 13.2, 13.3, 13.4, 13.5 |
| MyBatis-Plus (å¯é€‰) | 3.4.x / 3.5.x | Task 13.5 (JsqlParserSupport) |
| JSqlParser | 4.x | Task 13.2, 13.3, 13.4, 13.5 |

---

## 5. æ‰§è¡Œç­–ç•¥ä¸å…³é”®è·¯å¾„

### å…³é”®è·¯å¾„ï¼ˆCritical Pathï¼‰

```
Phase 12 Complete â†’ Task 13.1 (1 å¤©) â†’ Task 13.3 (2 å¤©) â†’ Phase 13 Complete
                  â†˜ Task 13.6 (1 å¤©) â†—

æ€»å…³é”®è·¯å¾„æ—¶é—´: 1 + 1 + 2 = 4 å¤©
```

**è¯´æ˜**: Task 13.1 å’Œ 13.6 å¯ä»¥å¹¶è¡Œå¼€å§‹ï¼Œä½† 13.1 å’Œ 13.6 éƒ½å®Œæˆåæ‰èƒ½å¼€å§‹ 13.3ã€‚

---

### å¹¶è¡Œæ‰§è¡Œç­–ç•¥

#### ç¬¬ä¸€æ‰¹ï¼ˆDay 1ï¼‰- å¯å¹¶è¡Œæ‰§è¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 13.1   â”‚     â”‚  Task 13.6   â”‚
â”‚  Interface   â”‚     â”‚  Context     â”‚
â”‚  (1 day)     â”‚     â”‚  (1 day)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å›¢é˜Ÿéœ€æ±‚**: 2 ä¸ª Agentï¼ˆæˆ– 1 ä¸ª Agent é¡ºåºæ‰§è¡Œï¼‰

---

#### ç¬¬äºŒæ‰¹ï¼ˆDay 2-4ï¼‰- å¯å¹¶è¡Œæ‰§è¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 13.2   â”‚  â”‚  Task 13.3   â”‚  â”‚  Task 13.4   â”‚  â”‚  Task 13.5   â”‚
â”‚Main Interceptâ”‚  â”‚Check Intercepâ”‚  â”‚Rewrite       â”‚  â”‚Limit Intercepâ”‚
â”‚  (2 days)    â”‚  â”‚  (2 days)    â”‚  â”‚(2 days)      â”‚  â”‚  (2 days)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–**: å¿…é¡»ç­‰å¾… Task 13.1 å’Œ 13.6 å®Œæˆ

**å›¢é˜Ÿéœ€æ±‚**: 4 ä¸ª Agentï¼ˆæˆ– 1 ä¸ª Agent é¡ºåºæ‰§è¡Œï¼Œè€—æ—¶ 8 å¤©ï¼‰

---

### ä¼˜åŒ–æ‰§è¡Œæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: å• Agent é¡ºåºæ‰§è¡Œï¼ˆä¿å®ˆï¼‰

```
Day 1-2:   Task 13.1 (1 day) â†’ Task 13.6 (1 day)
Day 3-4:   Task 13.3 (2 days)
Day 5-6:   Task 13.2 (2 days)
Day 7-8:   Task 13.5 (2 days)
Day 9-10:  Task 13.4 (2 days)

æ€»æ—¶é•¿: 10 å¤©
```

**ä¼˜åŠ¿**: æ— å¹¶è¡Œå†²çªï¼Œé€‚åˆå•äºº/å• Agent å¼€å‘
**åŠ£åŠ¿**: æ—¶é—´æœ€é•¿

---

#### æ–¹æ¡ˆ 2: å…³é”®è·¯å¾„ä¼˜å…ˆï¼ˆæ¨èï¼‰

```
Day 1:     Task 13.1 + Task 13.6 (å¹¶è¡Œï¼Œå• Agent å¯é¡ºåºæ‰§è¡Œ)
Day 2-3:   Task 13.3 (å…³é”®ï¼šæ¡¥æ¥ RuleChecker)
Day 4-5:   Task 13.2 (ä¸»æ‹¦æˆªå™¨)
Day 6-7:   Task 13.5 (è‡ªåŠ¨ LIMIT é™çº§)
Day 8-9:   Task 13.4 (å¯é€‰åŠŸèƒ½)

æ€»æ—¶é•¿: 9 å¤©
å…³é”®è·¯å¾„: 4 å¤©
```

**ä¼˜åŠ¿**: å…³é”®åŠŸèƒ½å…ˆå®ç°ï¼Œåç»­ä»»åŠ¡å¯é€‰
**åŠ£åŠ¿**: éœ€è¦åˆç†å®‰æ’ä»»åŠ¡é¡ºåº

---

#### æ–¹æ¡ˆ 3: å¤š Agent å¹¶è¡Œï¼ˆæ¿€è¿›ï¼‰

```
Day 1:     Task 13.1 (Agent 1) + Task 13.6 (Agent 2)
Day 2-3:   Task 13.2, 13.3, 13.4, 13.5 (4 ä¸ª Agent å¹¶è¡Œ)

æ€»æ—¶é•¿: 3 å¤©
```

**ä¼˜åŠ¿**: æœ€å¿«å®Œæˆ
**åŠ£åŠ¿**: éœ€è¦ 4 ä¸ª Agentï¼Œåè°ƒæˆæœ¬é«˜

---

## 6. é£é™©è¯„ä¼°

### é«˜é£é™©é¡¹

| é£é™© | ä»»åŠ¡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **StatementRewriter æ¥å£æœªå®šä¹‰** | Task 13.4 | é˜»å¡ 13.4 å¼€å‘ | åœ¨ Task 13.4 å¼€å§‹å‰å®šä¹‰æ¥å£ |
| **MyBatis å¤šç‰ˆæœ¬å…¼å®¹æ€§** | Task 13.2-13.5 | å¯èƒ½éœ€è¦é¢å¤–é€‚é…ä»£ç  | æå‰æµ‹è¯• 3.4.x å’Œ 3.5.x |
| **BoundSql åå°„ä¿®æ”¹** | Task 13.4 | ä¸åŒ MyBatis ç‰ˆæœ¬å®ç°å¯èƒ½ä¸åŒ | å°è£…åå°„é€»è¾‘ï¼Œæä¾›å¤šç‰ˆæœ¬é€‚é… |
| **ThreadLocal å†…å­˜æ³„æ¼** | Task 13.6 | ç”Ÿäº§ç¯å¢ƒå†…å­˜é—®é¢˜ | ä¸¥æ ¼ finally æ¸…ç†ï¼Œç¼–å†™æ³„æ¼æµ‹è¯• |
| **å¤šæ•°æ®åº“ Dialect å®ç°** | Task 13.5 | SQL æ–¹è¨€å·®å¼‚å¤§ | ä¼˜å…ˆå®ç° MySQLï¼Œå…¶ä»–æ•°æ®åº“è¿­ä»£ |

---

### ä¸­é£é™©é¡¹

| é£é™© | ä»»åŠ¡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **ä¼˜å…ˆçº§æœºåˆ¶å¤æ‚æ€§** | Task 13.2 | æ’åºé€»è¾‘å¯èƒ½å‡ºé”™ | TDDï¼Œå……åˆ†æµ‹è¯•ä¼˜å…ˆçº§æ’åº |
| **RuleChecker é›†æˆ** | Task 13.3 | éœ€è¦æ­£ç¡®æ¡¥æ¥ Phase 12 | å¤ç”¨ Phase 12 å·²æœ‰é€»è¾‘ |
| **JsqlParserSupport ä¾èµ–** | Task 13.5 | å¯èƒ½éœ€è¦ MyBatis-Plus | å¦‚æ— æ³•ä½¿ç”¨åˆ™è‡ªå·±å®ç° |

---

### ä½é£é™©é¡¹

| é£é™© | ä»»åŠ¡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **æ¥å£è®¾è®¡å˜æ›´** | Task 13.1 | éœ€è¦ä¿®æ”¹æ‰€æœ‰ InnerInterceptor | è®¾è®¡é˜¶æ®µå……åˆ†è¯„å®¡ |
| **æµ‹è¯•è¦†ç›–ä¸è¶³** | All | å¯èƒ½é—æ¼è¾¹ç•Œæƒ…å†µ | TDDï¼Œè¦æ±‚å……åˆ†æµ‹è¯• |

---

## 7. ä¾èµ–çŸ©é˜µ

### âš ï¸ æ³¨æ„ï¼šè¡¨ä¸­åˆ—å· 13.6 åœ¨æœ€å³ä¾§ï¼Œä½†å®ƒæ˜¯ç¬¬ä¸€æ‰¹è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼

### ä»»åŠ¡é—´ä¾èµ–çŸ©é˜µ

|        | 13.1 | 13.2 | 13.3 | 13.4 | 13.5 | 13.6 âš ï¸ |
|--------|------|------|------|------|------|---------|
| **13.1** | -    | âœ…   | âœ…   | âœ…   | âœ…   | âŒ   |
| **13.2** | âŒ   | -    | âŒ   | âŒ   | âŒ   | âœ…   |
| **13.3** | âŒ   | âŒ   | -    | âŒ   | âŒ   | âœ…   |
| **13.4** | âŒ   | âŒ   | âŒ   | -    | âŒ   | âœ…   |
| **13.5** | âŒ   | âŒ   | âŒ   | âŒ   | -    | âœ…   |
| **13.6** | âŒ   | âœ…   | âœ…   | âœ…   | âœ…   | -    |

**å›¾ä¾‹**:
- âœ… : ä¾èµ–ï¼ˆè¡Œä»»åŠ¡ä¾èµ–åˆ—ä»»åŠ¡ï¼‰
- âŒ : ä¸ä¾èµ–

**è§£è¯»**:
- Task 13.2, 13.3, 13.4, 13.5 éƒ½ä¾èµ– Task 13.1ï¼ˆéœ€è¦æ¥å£å®šä¹‰ï¼‰
- Task 13.2, 13.3, 13.4, 13.5 éƒ½ä¾èµ– Task 13.6ï¼ˆéœ€è¦ StatementContext å·¥å…·ç±»ï¼‰âš ï¸
- Task 13.1 å’Œ 13.6 æ— ç›¸äº’ä¾èµ–ï¼ˆå¯å¹¶è¡Œï¼‰
- Task 13.2, 13.3, 13.4, 13.5 ä¹‹é—´æ— ç›¸äº’ä¾èµ–ï¼ˆå¯å¹¶è¡Œï¼‰

**âš ï¸ å…³é”®ç†è§£**ï¼š
- è™½ç„¶ 13.6 åœ¨çŸ©é˜µæœ€å³ä¾§ï¼ˆç¼–å·æœ€åï¼‰ï¼Œä½†å®ƒæ˜¯ç¬¬ä¸€æ‰¹è¦æ‰§è¡Œçš„åŸºç¡€ä»»åŠ¡ï¼
- 13.2/13.3/13.4 çš„ä»£ç ä¸­ä¼šè°ƒç”¨ `StatementContext.cache()` å’Œ `StatementContext.get()`
- å› æ­¤ StatementContext ç±»ï¼ˆ13.6ï¼‰å¿…é¡»å…ˆåˆ›å»º

---

## 8. å»ºè®®æ‰§è¡Œé¡ºåº

### âš ï¸ é‡è¦æé†’
**Task 13.6 è™½ç„¶ç¼–å·ä¸º 13.6ï¼ˆæœ€åï¼‰ï¼Œä½†å¿…é¡»åœ¨ Phase 1 æ‰§è¡Œï¼ˆä¸ 13.1 å¹¶è¡Œï¼‰ï¼**
- Task 13.6 åˆ›å»º StatementContext åŸºç¡€è®¾æ–½
- Tasks 13.2/13.3/13.4 éƒ½éœ€è¦ä½¿ç”¨ StatementContext
- ç¼–å·é¡ºåº â‰  æ‰§è¡Œé¡ºåº

---

### æ¨èé¡ºåºï¼ˆå…³é”®è·¯å¾„ä¼˜å…ˆï¼‰

```
1ï¸âƒ£ Phase 1: Foundation (Day 1-2) â­ å¿…é¡»å…ˆå®Œæˆ
   â””â”€ Task 13.1 (Interface Design) - 1 day
   â””â”€ Task 13.6 (StatementContext) - 1 day âš ï¸ ç¼–å·è™½ä¸º13.6ä½†ä¼˜å…ˆæ‰§è¡Œï¼
       â”œâ”€ å¯å¹¶è¡Œæ‰§è¡Œ
       â””â”€ å»ºè®®å…ˆåš 13.1ï¼ˆæ¥å£å®šä¹‰æ›´åŸºç¡€ï¼‰

2ï¸âƒ£ Phase 2: Core Interceptors (Day 3-6) âš ï¸ ä¾èµ– 13.1 + 13.6 å®Œæˆ
   â””â”€ Task 13.3 (Check Interceptor) - 2 days â­ ä¼˜å…ˆ
       â””â”€ æœ€é‡è¦ï¼šæ¡¥æ¥ RuleChecker
       â””â”€ ä½¿ç”¨ StatementContext.get() å¤ç”¨è§£æ
   â””â”€ Task 13.2 (Main Interceptor) - 2 days
       â””â”€ åè°ƒæ‰€æœ‰ InnerInterceptor
       â””â”€ ä½¿ç”¨ StatementContext.cache() ç¼“å­˜

3ï¸âƒ£ Phase 3: Additional Interceptors (Day 7-10) âš ï¸ ä¾èµ– 13.1 + 13.6 å®Œæˆ
   â””â”€ Task 13.5 (Limit Interceptor) - 2 days â­ æ¨è
       â””â”€ é‡è¦é™çº§åŠŸèƒ½
   â””â”€ Task 13.4 (Rewrite Interceptor) - 2 days (å¯é€‰)
       â””â”€ é«˜çº§åŠŸèƒ½ï¼Œå¯å»¶å
       â””â”€ ä½¿ç”¨ StatementContext.get() å¤ç”¨è§£æ

æ€»æ—¶é•¿: 10 å¤©ï¼ˆå• Agent é¡ºåºæ‰§è¡Œï¼‰
å…³é”®è·¯å¾„: 4 å¤©ï¼ˆTask 13.1 + 13.6 â†’ 13.3ï¼‰
```

---

## 9. éªŒæ”¶æ£€æŸ¥æ¸…å•

### Phase 13 å®Œæˆå‰æ£€æŸ¥

- [ ] **Task 13.1**: SqlGuardInnerInterceptor æ¥å£è®¾è®¡å®Œæˆ
  - [ ] 5 ä¸ªæ–¹æ³•ç­¾åæ­£ç¡®
  - [ ] Javadoc å®Œæ•´
  - [ ] 8 ä¸ªæµ‹è¯•é€šè¿‡

- [ ] **Task 13.6**: StatementContext å®ç°å®Œæˆ
  - [ ] ThreadLocal ç¼“å­˜æ­£å¸¸å·¥ä½œ
  - [ ] æ— å†…å­˜æ³„æ¼
  - [ ] 10 ä¸ªæµ‹è¯•é€šè¿‡

- [ ] **Task 13.3**: SqlGuardCheckInnerInterceptor å®ç°å®Œæˆ
  - [ ] RuleChecker æ¡¥æ¥æ­£ç¡®
  - [ ] ViolationStrategy å¤„ç†æ­£ç¡®
  - [ ] 15 ä¸ªæµ‹è¯•é€šè¿‡

- [ ] **Task 13.2**: SqlGuardInterceptor å®ç°å®Œæˆ
  - [ ] ä¼˜å…ˆçº§æ’åºæ­£ç¡®
  - [ ] ç”Ÿå‘½å‘¨æœŸè°ƒç”¨æ­£ç¡®
  - [ ] ThreadLocal æ¸…ç†æ­£ç¡®
  - [ ] 12 ä¸ªæµ‹è¯•é€šè¿‡

- [ ] **Task 13.5**: SelectLimitInnerInterceptor å®ç°å®Œæˆ
  - [ ] åˆ†é¡µæ£€æµ‹å‡†ç¡®
  - [ ] æ”¯æŒ 4 ç§æ•°æ®åº“æ–¹è¨€
  - [ ] 20 ä¸ªæµ‹è¯•é€šè¿‡

- [ ] **Task 13.4**: SqlGuardRewriteInnerInterceptor å®ç°å®Œæˆï¼ˆå¯é€‰ï¼‰
  - [ ] BoundSql åå°„ä¿®æ”¹æ­£ç¡®
  - [ ] é“¾å¼é‡å†™æ”¯æŒ
  - [ ] 12 ä¸ªæµ‹è¯•é€šè¿‡

---

## 10. æ€»ç»“

### å…³é”®å‘ç°

1. **âš ï¸ ä»»åŠ¡ç¼–å· â‰  æ‰§è¡Œé¡ºåºï¼ˆæœ€é‡è¦ï¼‰**
   - Task 13.6 ç¼–å·è™½ä¸ºæœ€åï¼ˆ13.6ï¼‰ï¼Œä½†å¿…é¡»åœ¨ Phase 1 ä¼˜å…ˆæ‰§è¡Œ
   - åŸå› ï¼š13.6 åˆ›å»º StatementContext åŸºç¡€è®¾æ–½ï¼Œ13.2/13.3/13.4 éƒ½ä¾èµ–å®ƒ
   - **æ•™è®­**ï¼šä¸è¦è¢«ä»»åŠ¡ç¼–å·è¯¯å¯¼ï¼Œå§‹ç»ˆæ ¹æ®å®é™…ä¾èµ–å…³ç³»ç¡®å®šæ‰§è¡Œé¡ºåº

2. **Task 13.1 å’Œ 13.6 æ˜¯å…³é”®åŸºç¡€ä»»åŠ¡**
   - æ— ç›¸äº’ä¾èµ–ï¼Œå¯å¹¶è¡Œå¼€å§‹
   - å…¶ä»–æ‰€æœ‰ä»»åŠ¡éƒ½ä¾èµ–è¿™ä¸¤ä¸ªä»»åŠ¡
   - å»ºè®®æ‰§è¡Œé¡ºåºï¼š13.1ï¼ˆæ¥å£ï¼‰ â†’ 13.6ï¼ˆå·¥å…·ç±»ï¼‰ æˆ–å¹¶è¡Œ

3. **Task 13.3 æ˜¯æœ€é‡è¦çš„ InnerInterceptor**
   - æ¡¥æ¥ Phase 12 çš„ RuleChecker
   - åº”ä¼˜å…ˆå®ç°å¹¶å……åˆ†æµ‹è¯•
   - ä½¿ç”¨ StatementContext.get() å¤ç”¨å·²è§£æçš„ Statement

4. **Task 13.2, 13.3, 13.4, 13.5 å¯å¹¶è¡Œæ‰§è¡Œ**
   - å‰æï¼šTask 13.1 å’Œ 13.6 éƒ½å·²å®Œæˆ
   - å¦‚æœ‰å¤šä¸ª Agentï¼Œå¯å¤§å¹…ç¼©çŸ­æ—¶é—´ï¼ˆ10 å¤© â†’ 3 å¤©ï¼‰
   - å• Agent é¡ºåºæ‰§è¡Œå»ºè®®ä¼˜å…ˆçº§ï¼š13.3 > 13.2 > 13.5 > 13.4

5. **Phase 13 å¯¹ Phase 12 æœ‰å¼ºä¾èµ–**
   - RuleChecker æ¥å£å’Œå®ç°
   - SqlContext.statement å­—æ®µ
   - JSqlParserFacade
   - âœ… Phase 12 å·²å®Œæˆï¼Œä¾èµ–æ»¡è¶³

6. **é£é™©å¯æ§**
   - ä¸»è¦é£é™©æ˜¯å¤šç‰ˆæœ¬å…¼å®¹æ€§å’Œ ThreadLocal å†…å­˜æ³„æ¼
   - é€šè¿‡å……åˆ†æµ‹è¯•å’Œä¸¥æ ¼æ¸…ç†å¯ä»¥ç¼“è§£

### æœ€ä¼˜æ‰§è¡Œç­–ç•¥

**æ¨è**: å…³é”®è·¯å¾„ä¼˜å…ˆï¼ˆ9-10 å¤©ï¼‰

```
Phase 1 (Day 1-2): âš ï¸ åŸºç¡€ä»»åŠ¡ä¼˜å…ˆ
   â”œâ”€ Task 13.1 (Interface)
   â””â”€ Task 13.6 (StatementContext) âš ï¸ è™½ç¼–å·ä¸º13.6ä½†å¿…é¡»æ­¤æ—¶æ‰§è¡Œ

Phase 2 (Day 3-6): æ ¸å¿ƒæ‹¦æˆªå™¨
   â”œâ”€ Task 13.3 (Check Interceptor) â­ ä¼˜å…ˆ
   â””â”€ Task 13.2 (Main Interceptor)

Phase 3 (Day 7-10): é¢å¤–æ‹¦æˆªå™¨
   â”œâ”€ Task 13.5 (Limit Interceptor) â­ æ¨è
   â””â”€ Task 13.4 (Rewrite Interceptor) - å¯é€‰
```

### ä¾èµ–å…³ç³»å›¾ï¼ˆä¿®æ­£ç‰ˆï¼‰

```
                    [Phase 12 Complete]
                           â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                         â”‚
        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚  Task 13.1 â”‚             â”‚Task 13.6â”‚ âš ï¸ ç¼–å·è™½ä¸º13.6
        â”‚  Interface â”‚             â”‚ Context â”‚    ä½†ä¼˜å…ˆæ‰§è¡Œï¼
        â”‚   Design   â”‚             â”‚ThreadLclâ”‚
        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚                         â”‚
              â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚         â”‚
              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
                    â”‚         â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚            â”‚         â”‚            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Task 13.2  â”‚ â”‚Task 13.3â”‚ â”‚Task 13.4â”‚ â”‚Task 13.5 â”‚
â”‚   Main     â”‚ â”‚  Check  â”‚ â”‚ Rewrite â”‚ â”‚  Limit   â”‚
â”‚Interceptor â”‚ â”‚  Inner  â”‚ â”‚  Inner  â”‚ â”‚  Inner   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚            â”‚           â”‚            â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
                          â”‚  Phase 13 â”‚
                          â”‚  Complete â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Created**: 2025-12-22
**Phase**: 13 - InnerInterceptor Architecture
**Document Type**: Dependency Analysis
