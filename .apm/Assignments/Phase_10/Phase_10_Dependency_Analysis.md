# Phase 10 - SQL Audit Service ä¾èµ–å…³ç³»åˆ†æ

**åˆ›å»ºæ—¶é—´:** 2025-12-18
**Manager Agent:** Manager_Agent_3
**çŠ¶æ€:** åˆ†æå®Œæˆ (å·²ä¼˜åŒ–å¹¶è¡Œæ‰§è¡Œ)

---

## 1. ä»»åŠ¡æ¦‚è§ˆ

| Task | åç§° | Agent | æµ‹è¯•æ•° | ä¾èµ– | å¹¶è¡Œ |
|------|------|-------|-------|------|------|
| 10.1 | Project Foundation & Architecture Setup | Agent_Audit_Service | 40+ | Phase 9 (external) | - |
| 10.2 | Kafka Consumer with Virtual Threads | Agent_Audit_Service | 45+ | 10.1, Phase 8.1 | â­ 10.3 |
| 10.3 | Audit Engine & Checker Orchestration | Agent_Audit_Service | 50+ | 10.1, Phase 9.2/9.3/9.4 | â­ 10.2 |
| 10.4 | Storage Layer: PostgreSQL & ClickHouse | Agent_Audit_Service | 55+ | 10.3, Phase 8.1 | - |
| 10.5 | REST API & Monitoring Endpoints | Agent_Audit_Service | 50+ | 10.3, 10.4 | - |

**æ€»æµ‹è¯•æ•°:** 240+ tests

---

## 2. ä¾èµ–å…³ç³»å›¾ (ä¼˜åŒ–å)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¤–éƒ¨ä¾èµ–                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Phase 8.1: AuditEvent JSON Schema (sql-guard-audit-api)           â”‚
â”‚  Phase 9: Audit Checkers Library (sql-guard-audit-checker)         â”‚
â”‚    - Task 9.1: AbstractAuditChecker                                 â”‚
â”‚    - Task 9.2: P0 Checkers (SlowQueryChecker, etc.)                â”‚
â”‚    - Task 9.3: P1 Checkers (LargeResultChecker, etc.)              â”‚
â”‚    - Task 9.4: P2 Checkers (ErrorPatternChecker - stateless)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 10.1 - Project Foundation & Architecture Setup  âœ… å·²å®Œæˆ     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  è¾“å‡º:                                                               â”‚
â”‚  - Maven multi-module project (Java 21)                             â”‚
â”‚  - audit-service-core / audit-service-web / audit-service-consumer  â”‚
â”‚  - Virtual Thread executor configuration                            â”‚
â”‚  - Docker Compose (Kafka, PostgreSQL, ClickHouse)                  â”‚
â”‚  - application.yml (dev/staging/prod profiles)                      â”‚
â”‚                                                                     â”‚
â”‚  çŠ¶æ€: âœ… å·²å®Œæˆ (40 tests)                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â†“                               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 10.2 - Kafka Consumer   â”‚ â”‚  Task 10.3 - Audit Engine         â”‚
â”‚  â­ å¯ä¸ 10.3 å¹¶è¡Œæ‰§è¡Œ         â”‚ â”‚  â­ å¯ä¸ 10.2 å¹¶è¡Œæ‰§è¡Œ             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä¾èµ–: 10.1 Output            â”‚ â”‚  ä¾èµ–: 10.1 Output                â”‚
â”‚  å¤–éƒ¨: Phase 8.1 AuditEvent   â”‚ â”‚  å¤–éƒ¨: Phase 9 Checkers           â”‚
â”‚                               â”‚ â”‚                                   â”‚
â”‚  è¾“å‡º:                        â”‚ â”‚  è¾“å‡º:                            â”‚
â”‚  - KafkaAuditEventConsumer    â”‚ â”‚  - AuditEngine interface          â”‚
â”‚  - è°ƒç”¨ AuditEventProcessor   â”‚ â”‚  - å®ç° AuditEventProcessor       â”‚
â”‚  - Virtual Thread executor    â”‚ â”‚  - å®šä¹‰ AuditReportRepository     â”‚
â”‚  - Backpressure handling      â”‚ â”‚  - CompletableFuture å¹¶è¡Œç¼–æ’     â”‚
â”‚  - Error handling & DLQ       â”‚ â”‚  - Checker registry               â”‚
â”‚  - Micrometer metrics         â”‚ â”‚  - Result aggregation             â”‚
â”‚                               â”‚ â”‚                                   â”‚
â”‚  çŠ¶æ€: ğŸŸ¡ Ready               â”‚ â”‚  çŠ¶æ€: ğŸŸ¡ Ready                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                               â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚          å…±äº«æ¥å£: AuditEventProcessor              â”‚
          â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚  package com.footstone.audit.service.core.processor â”‚
          â”‚                                                     â”‚
          â”‚  public interface AuditEventProcessor {             â”‚
          â”‚      AuditProcessingResult process(AuditEvent e);   â”‚
          â”‚  }                                                  â”‚
          â”‚                                                     â”‚
          â”‚  Task 10.2: å®šä¹‰æ¥å£ï¼Œè°ƒç”¨ processor               â”‚
          â”‚  Task 10.3: å®ç°æ¥å£ (DefaultAuditEngine)          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 10.4 - Storage Layer: PostgreSQL & ClickHouse                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä¾èµ–: Task 10.3 Output (AuditReport model, Repository interface)  â”‚
â”‚  å¤–éƒ¨ä¾èµ–: Task 8.1 Output (AuditEvent model)                       â”‚
â”‚                                                                     â”‚
â”‚  å…³é”®åŠŸèƒ½:                                                           â”‚
â”‚  - PostgreSQL-Only æ¨¡å¼ (High Fix H2)                               â”‚
â”‚    é€‚åˆ <1M events/day ä¸­å°è§„æ¨¡åœºæ™¯                                  â”‚
â”‚                                                                     â”‚
â”‚  è¾“å‡º:                                                               â”‚
â”‚  - PostgreSQL schema (audit_reports, JPA)                           â”‚
â”‚  - ClickHouse schema (sql_executions, MergeTree)                    â”‚
â”‚  - å®ç° AuditReportRepository (JPA)                                 â”‚
â”‚  - ClickHouseExecutionLogger (JDBC batch)                           â”‚
â”‚  - PostgreSQLOnlyStorageAdapter (H2)                                â”‚
â”‚  - Data retention policies                                          â”‚
â”‚                                                                     â”‚
â”‚  çŠ¶æ€: â³ ç­‰å¾… Task 10.3                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Task 10.5 - REST API & Monitoring Endpoints                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  ä¾èµ–: Task 10.3 Output (AuditEngine for query)                     â”‚
â”‚        Task 10.4 Output (repositories for data access)              â”‚
â”‚                                                                     â”‚
â”‚  è¾“å‡º:                                                               â”‚
â”‚  - AuditReportController (GET /api/v1/audits)                       â”‚
â”‚  - StatisticsController (GET /api/v1/statistics)                    â”‚
â”‚  - ConfigurationController (PUT /api/v1/checkers/{id}/config)       â”‚
â”‚  - OpenAPI documentation (Swagger UI)                               â”‚
â”‚  - Health endpoints (/actuator/health)                              â”‚
â”‚  - Metrics endpoints (/actuator/prometheus)                         â”‚
â”‚                                                                     â”‚
â”‚  çŠ¶æ€: â³ ç­‰å¾… Task 10.3 + Task 10.4                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. æ‰§è¡Œé¡ºåº (ä¼˜åŒ–å)

**åŸå§‹æ–¹æ¡ˆ (ä¸²è¡Œ):**
```
æ‰¹æ¬¡ 1: Task 10.1 (Foundation)
æ‰¹æ¬¡ 2: Task 10.2 (Kafka Consumer)
æ‰¹æ¬¡ 3: Task 10.3 (Audit Engine)
æ‰¹æ¬¡ 4: Task 10.4 (Storage)
æ‰¹æ¬¡ 5: Task 10.5 (REST API)
æ€»è®¡: 5 æ‰¹æ¬¡
```

**ä¼˜åŒ–æ–¹æ¡ˆ (éƒ¨åˆ†å¹¶è¡Œ): â­ æ¨è**
```
æ‰¹æ¬¡ 1: Task 10.1 (Foundation)           âœ… å·²å®Œæˆ
æ‰¹æ¬¡ 2: Task 10.2 + Task 10.3 (å¹¶è¡Œ)     ğŸŸ¡ å¯åŒæ—¶æ‰§è¡Œ
æ‰¹æ¬¡ 3: Task 10.4 (Storage)              â³ ç­‰å¾…æ‰¹æ¬¡2
æ‰¹æ¬¡ 4: Task 10.5 (REST API)             â³ ç­‰å¾…æ‰¹æ¬¡3
æ€»è®¡: 4 æ‰¹æ¬¡ (èŠ‚çº¦ 20% æ—¶é—´)
```

### å¹¶è¡Œæ‰§è¡Œçš„å…³é”®

1. **é¢„å®šä¹‰å…±äº«æ¥å£:** `AuditEventProcessor`
   - Task 10.2 å®šä¹‰æ¥å£ï¼Œä½¿ç”¨ Mock å®ç°æµ‹è¯•
   - Task 10.3 å®ç°æ¥å£ (DefaultAuditEngine)

2. **æ¥å£ä½ç½®:** `sql-audit-service-core` æ¨¡å—

3. **é›†æˆæ—¶æœº:** ä¸¤ä¸ªä»»åŠ¡éƒ½å®Œæˆåï¼Œå°† DefaultAuditEngine æ³¨å…¥ KafkaAuditEventConsumer

---

## 4. å…³é”®æŠ€æœ¯å†³ç­–

### 4.1 Java 21 ç‰¹æ€§ä½¿ç”¨ç­–ç•¥

| ç‰¹æ€§ | ä½¿ç”¨çŠ¶æ€ | è¯´æ˜ |
|------|---------|------|
| Virtual Threads | âœ… ä½¿ç”¨ | `Executors.newVirtualThreadPerTaskExecutor()` |
| Record Classes | âœ… ä½¿ç”¨ | ä¸å¯å˜é¢†åŸŸæ¨¡å‹ |
| Pattern Matching | âœ… ä½¿ç”¨ | SQLç±»å‹åˆ‡æ¢ |
| Structured Concurrency | âŒ ä¸ä½¿ç”¨ | Previewç‰¹æ€§ï¼Œç”¨ CompletableFuture.allOf() æ›¿ä»£ (C1) |

### 4.2 éƒ¨ç½²æ¨¡å¼

| æ¨¡å¼ | é€‚ç”¨åœºæ™¯ | å­˜å‚¨æ–¹æ¡ˆ |
|------|---------|---------|
| å®Œæ•´æ¨¡å¼ | >1M events/day | PostgreSQL + ClickHouse |
| ç®€åŒ–æ¨¡å¼ (H2) | <1M events/day | PostgreSQL-Only (BRINç´¢å¼•) |

---

## 5. é£é™©ä¸ç¼“è§£

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| Structured Concurrency Preview | ç”Ÿäº§ä¸ç¨³å®š | ä½¿ç”¨ CompletableFuture.allOf() (C1) |
| ClickHouse è¿ç»´å¤æ‚ | ä¸­å°å›¢é˜Ÿè´Ÿæ‹… | PostgreSQL-Only æ¨¡å¼ (H2) |
| Virtual Thread é—®é¢˜ | æ€§èƒ½ä¸‹é™ | ç›‘æ§ + å¹³å°çº¿ç¨‹å›é€€ (M10) |
| å¹¶è¡Œä»»åŠ¡æ¥å£ä¸åŒ¹é… | é›†æˆå¤±è´¥ | é¢„å®šä¹‰ AuditEventProcessor æ¥å£ |

---

## 6. å½“å‰è¿›åº¦

| æ‰¹æ¬¡ | ä»»åŠ¡ | çŠ¶æ€ | æµ‹è¯• |
|------|------|------|------|
| 1 | Task 10.1 | âœ… å®Œæˆ | 40 (32+8 @Disabled) |
| 2 | Task 10.2 + 10.3 | ğŸŸ¡ å¾…åˆ†é… | 95+ è®¡åˆ’ |
| 3 | Task 10.4 | â³ ç­‰å¾… | 55+ è®¡åˆ’ |
| 4 | Task 10.5 | â³ ç­‰å¾… | 50+ è®¡åˆ’ |

---

**Last Updated:** 2025-12-18
**Next Action:** å¹¶è¡Œåˆ†é… Task 10.2 å’Œ Task 10.3 åˆ° Agent_Audit_Service
