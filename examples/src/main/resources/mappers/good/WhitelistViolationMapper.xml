<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--
  CORRECTED VERSION: WhitelistFields Fixed
  FIX APPLIED: Added required tenant_id field to all WHERE clauses
  
  KEY IMPROVEMENTS:
  - All queries now include tenant_id for multi-tenant isolation
  - Prevents cross-tenant data leakage
  - Ensures compliance with data privacy regulations
  
  SAFETY GUARANTEE: All queries properly isolated by tenant
-->
<mapper namespace="com.footstone.sqlguard.examples.good.WhitelistViolationMapper">

    <!-- GOOD: SELECT with tenant_id -->
    <select id="selectOrdersWithTenant" resultType="map">
        SELECT * FROM orders 
        WHERE tenant_id = #{tenantId} AND user_id = #{userId}
    </select>

    <!-- GOOD: UPDATE with tenant_id -->
    <update id="updateOrderWithTenant">
        UPDATE orders 
        SET status = 'completed' 
        WHERE tenant_id = #{tenantId} AND order_id = #{orderId}
    </update>

    <!-- GOOD: DELETE with tenant_id -->
    <delete id="deleteOrderWithTenant">
        DELETE FROM orders 
        WHERE tenant_id = #{tenantId} AND order_id = #{orderId}
    </delete>

    <!-- GOOD: Complex WHERE with tenant_id -->
    <select id="selectUserOrdersWithTenant" resultType="map">
        SELECT * FROM orders 
        WHERE tenant_id = #{tenantId} 
          AND user_id = #{userId} 
          AND status = 'pending' 
          AND created_at > #{startDate}
    </select>

    <!-- GOOD: JOIN query with tenant_id on both tables -->
    <select id="selectOrderDetailsWithTenant" resultType="map">
        SELECT o.*, od.* 
        FROM orders o 
        JOIN order_details od ON o.order_id = od.order_id 
        WHERE o.tenant_id = #{tenantId} 
          AND od.tenant_id = #{tenantId} 
          AND o.user_id = #{userId}
    </select>

</mapper>


